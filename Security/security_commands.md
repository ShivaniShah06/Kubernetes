## :closed_lock_with_key: SECURITY (TLS)

### Certificate Authority (CA):
1. Generate keys

       $ openssl genrsa -out ca.key 2048

2. Generate Certificate Signing Request (CSR)
 
        $ openssl req -new -key ca.key -subj "/CN=KUBERNETES-CA" -out ca.csr

3. Sign certificates
      
        $ openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt

### Generating Client Certificates

#### Admin User Certificates
1. Generate Keys

          $ openssl genrsa -out admin.key 2048

2. Generate Certificate Signing Request (CSR)
  
          $ openssl req -new -key admin.key -subj "/CN=kube-admin/O=system:masters" -out admin.csr

3. Sign certificates
  
          $ openssl x509 -req -in admin.csr -CA ca.crt -CAKey ca.key -out admin.crt

* Can add a `--config` flag for kube-apiserver certs as it needs more alternative names. config flag should point to a yaml file which has details about the alternate names.

### Certificates API

1. Get certificate signing requests

       $ kubectl get csr

2. Approve certificate signing request

       $ kubectl certificate approve <name_of_certificate>

3. View certificate in yaml format
 
       $ kubectl get csr <name_of_certificate> -o yaml

4. Delete certificate
    
       $ kubectl delete csr <name_of_certificate>

5. Reject certificate
  
       $ kubectl certificate deny <name_of_certificate>

### KubeConfig
Specifies Clusters, Contexts, and Users

1. List clusters, users, contexts, and current context (default from `$HOME/.kube/config` file)
  
        $ kubectl config view

2. List clusters, users, contexts, and current context from a specified file

        $ kubectl config view --kubeconfig=my-custom-config

3. Change context (also reflects in yaml file after running this)
         
         $ kubectl config use-context <context_name>

4. Make other changes to the config file using other commands

         $ kubectl config -h

### Role and Role Bindings
1. Get roles

        $ kubectl get roles

2. Get rolebindings
 
        $ kubectl get rolebindings

3. Describe a role
 
        $ kubectl describe role <role_name>

4. Describe rolebinding

        $ kubectl describe rolebinding <rolebinding_name>

5. Check your own access

        $ kubectl auth can-i create deployments

        $ kubectl auth can-i delete nodes

6. Admin can impersonate other user to validate permissions given using below command option

        $ kubectl auth can-i create deployments --as <user_name>

        $ kubectl auth can-i create deployments --as <user_name> --namespace <namespace_name>

7. Imperative command to create role
  
        $ kubctl create role --help


### ServiceAccounts

1. Create a Service Account

        $ kubectl create serviceaccount <service_account_name>

2. Create a token in service account using token API

        $ kubectl create token <existing_service_account_name>

        note: token generated by this command will have an expiry of 1 hour after creation if not defined otherwise while creating it

### Image security

1. Login to private repository

        $ docker login private-registry.io

        Use login credentials

2. Run the image from the private registry

        $ docker run private-registry.io/apps/internal-app

3. Command to create secrets to be passed to the worker nodes

        $ kubectl create secret docker-registry <secret_name> \
        --docker-server= <registry_server_name> \
        -- docker-username= <docker_user_name> \
        -- docker-password= <user_password> \
        -- docker-email= <user_email_address>

### Docker security
1. Run a command with added privileges

        $ docker run --cap-add MAC_ADMIN ubuntu

2. Run a command with dropped privileges

        $ docker run --cap-drop KILL ubuntu

3. Run a command with all the privileges

        $ docker run --privileged

-> Get a list of namespaced resources

        $ kubectl api-resources --namespaced=true

-> Get a list of non-namespaced resources

        $ kubectl api-resources --namespaced=false

-> Get a list of all the resources regardless of namespaced or not

         $ kubectl api-resources
NOTE:
1. kube proxy != kubectl proxy
   
       kube proxy: Used to enable connectivity between pods and services across various nodes in the cluster

       kubectl proxy: An HTTP proxy service created by kubectl utility to access the kube-apiserver